<div class="flex h-screen overflow-hidden">
    <app-sidebar *ngIf="router.url === '/admin/order-management'"></app-sidebar>
    <div class="flex-1 flex flex-col overflow-hidden">
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100">
            <div class="container mx-auto px-6 py-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col lg:flex-row justify-between items-center mb-6 space-y-4 lg:space-y-0">
                        <h1 class="text-2xl font-bold w-full lg:w-1/4">
                            Quản lý đơn hàng
                        </h1>
                        <div class="w-full lg:w-1/2 px-4">
                            <div class="mb-4">
                                <input type="text" [(ngModel)]="searchTerm" placeholder="Tìm kiếm theo tên người đặt..."
                                    class="border border-gray-300 rounded px-3 py-2 w-full">
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row w-full lg:w-1/4 space-y-2 sm:space-y-0 sm:space-x-2">
                            <!-- <button (click)="openFileUploadPopup()"
                                class="w-full sm:w-1/2 bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                                Nhập
                            </button>
                            <button (click)="openAddProductPopup()"
                                class="w-full sm:w-1/2 bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                Thêm sản phẩm
                            </button> -->
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b text-left">ID</th>
                                    <th class="py-2 px-4 border-b text-left">Tên người đặt</th>
                                    <th class="py-2 px-4 border-b text-left">Email</th>
                                    <th class="py-2 px-4 border-b text-left">Số điện thoại</th>
                                    <th class="py-2 px-4 border-b text-left">Mã theo dõi</th>
                                    <th class="py-2 px-4 border-b text-left">Trạng thái</th>
                                    <th class="py-2 px-4 border-b text-left">Ngày đặt hàng</th>
                                    <th class="py-2 px-4 border-b text-left">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let item of orders; let i = index" class="text-sm md:text-base"
                                    [ngClass]="{'highlight': isMatchingSearch(item.full_name)}">
                                    <td class="py-2 px-4 border-b">{{ i + 1 }}</td>
                                    <td class="py-2 px-4 border-b">
                                        {{ item.full_name }}
                                    </td>
                                    <td class="py-2 px-4 border-b">{{ item.email }}</td>
                                    <td class="py-2 px-4 border-b">{{ item.phone_number }}</td>
                                    <td class="py-2 px-4 border-b">{{ item.tracking_number }}</td>
                                    <td class="py-2 px-4 border-b">
                                        {{ item.status | statusOrder }}
                                    </td>
                                    <td class="py-2 px-4 border-b">{{ item.order_date | date:'dd/MM/yyyy HH:mm' }}</td>
                                    <td class="py-2 px-4 border-b">
                                        <div class="flex space-x-2">
                                            <button
                                                class="bg-blue-500 hover:bg-blue-700 text-xs text-white px-2 py-1 rounded flex-grow sm:flex-grow-0 whitespace-nowrap"
                                                (click)="openDetailOrder(item.product_order_id)">
                                                Xem chi tiết
                                            </button>
                                            <button
                                                class="bg-red-500 hover:bg-red-700 text-xs text-white px-2 py-1 rounded flex-grow sm:flex-grow-0"
                                                (click)="openDeleteProductPopup(item.product_order_id)">
                                                Xoá
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Popup Cập nhật -->
                    <!-- <div *ngIf="isUpdatePopupOpen"
                        class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-lg w-[800px]">
                            <h2 class="text-lg font-bold mb-4">Cập nhật đơn hàng</h2>
                            <form class="grid grid-cols-2 gap-4" (ngSubmit)="confirmUpdate()">
                                <div>
                                    <label class="block mb-1 text-gray-400">Mã đơn hàng</label>
                                    <input type="text" [(ngModel)]="selectedOrder.product_order_id" name="order_id"
                                        readonly class="border border-gray-300 p-2 w-full rounded bg-gray-100" />
                                </div>
                                <div>
                                    <label class="block mb-1 text-gray-400">Tên khách hàng</label>
                                    <input type="text" [(ngModel)]="selectedOrder.full_name" name="full_name" required
                                        class="border border-gray-300 p-2 w-full rounded" />
                                </div>
                                <div>
                                    <label class="block mb-1 text-gray-400">Ngày đặt hàng</label>
                                    <input type="text" [(ngModel)]="selectedOrder.order_date" name="order_date" required
                                        class="border border-gray-300 p-2 w-full rounded" />
                                </div>
                                <div>
                                    <label class="block mb-1 text-gray-400">Tổng tiền</label>
                                    <input type="number" [(ngModel)]="selectedOrder.total_amount" name="total_amount"
                                        required class="border border-gray-300 p-2 w-full rounded" />
                                </div>
                                <div>
                                    <label class="block mb-1 text-gray-400">Trạng thái đơn hàng</label>
                                    <select [(ngModel)]="selectedOrder.status" name="status" required
                                        class="border border-gray-300 p-2 w-full rounded">
                                        <option *ngFor="let status of getAvailableStatuses()"
                                            [value]="status">
                                            {{ status | statusOrder }}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <label class="block mb-1 text-gray-400">Địa chỉ giao hàng</label>
                                    <textarea [(ngModel)]="selectedOrder.shipping_address" name="shipping_address"
                                        required class="border border-gray-300 p-2 w-full rounded" rows="3"></textarea>
                                </div>

                                <div class="col-span-2 flex justify-end mt-4">
                                    <button type="submit"
                                        class="bg-green-500 hover:bg-green-700 text-white mr-4 px-4 py-2 rounded">
                                        Cập nhật
                                    </button>
                                    <button type="button" (click)="closePopup()"
                                        class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">
                                        Đóng
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div> -->
                    <!-- Popup Thêm -->




                    <!-- Popup chi tiết đơn hàng -->
                    <div *ngIf="isDetailPopupOpen"
                        class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-lg w-[800px]">
                            <h2 class="text-lg font-bold mb-4">Chi tiết đơn hàng</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-1 text-gray-400">Mã đơn hàng</label>
                                    <p class="border border-gray-300 p-2 w-full rounded bg-gray-100">{{
                                        selectedOrder.product_order_id }}</p>
                                </div>
                                <div>
                                    <label class="block mb-1 text-gray-400">Tên khách hàng</label>
                                    <p class="border border-gray-300 p-2 w-full rounded bg-gray-100">{{
                                        selectedOrder.full_name }}</p>
                                </div>
                                <div>
                                    <label class="block mb-1 text-gray-400">Email</label>
                                    <p class="border border-gray-300 p-2 w-full rounded bg-gray-100">{{
                                        selectedOrder.email }}</p>
                                </div>
                                <div>
                                    <label class="block mb-1 text-gray-400">Số điện thoại</label>
                                    <p class="border border-gray-300 p-2 w-full rounded bg-gray-100">{{
                                        selectedOrder.phone_number }}</p>
                                </div>
                                <div>
                                    <label class="block mb-1 text-gray-400">Ngày đặt hàng</label>
                                    <p class="border border-gray-300 p-2 w-full rounded bg-gray-100">{{
                                        selectedOrder.order_date | date:'dd/MM/yyyy HH:mm' }}</p>
                                </div>
                                <div>
                                    <label class="block mb-1 text-gray-400">Trạng thái đơn hàng</label>
                                    <select [(ngModel)]="selectedOrder.status" name="status" required
                                        class="border border-gray-300 p-2 w-full rounded">
                                        <option *ngFor="let status of getAvailableStatuses()" [value]="status">
                                            {{ status | statusOrder }}
                                        </option>
                                    </select>
                                </div>

                                <div class="col-span-2">
                                    <label class="block mb-1 text-gray-400">Địa chỉ giao hàng</label>
                                    <p class="border border-gray-300 p-2 w-full rounded bg-gray-100">{{
                                        selectedOrder.shipping_address }}</p>
                                </div>
                                <div class="col-span-2">
                                    <label class="block mb-1 text-gray-400">Ghi chú</label>
                                    <p class="border border-gray-300 p-2 w-full h-12 rounded bg-gray-100">{{
                                        selectedOrder.note }}</p>
                                </div>
                                <div class="col-span-2">
                                    <label class="block mb-1 text-gray-400">Sản phẩm đã đặt</label>
                                    <table class="w-full border-collapse border border-gray-300">
                                        <thead>
                                            <tr class="bg-gray-100">
                                                <th class="border border-gray-300 p-2">Tên sản phẩm</th>
                                                <th class="border border-gray-300 p-2">Loại hàng</th>
                                                <th class="border border-gray-300 p-2">Số lượng</th>
                                                <th class="border border-gray-300 p-2">Số lượng tồn kho</th>
                                                <th class="border border-gray-300 p-2">Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr
                                                *ngFor="let item of selectedOrder?.product_order_detail_list_responses; let i = index">
                                                <td class="border border-gray-300 p-2">{{ item.product_name }}</td>
                                                <td class="border border-gray-300 p-2">{{ item.category_name }}</td>
                                                <td class="border border-gray-300 p-2 text-center">
                                                    <input type="number" 
                                                           [value]="item.quantity"
                                                           (input)="updateQuantity(i, $event)" 
                                                           style="-moz-appearance: textfield; appearance: textfield;"
                                                           class="w-20 text-center px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                                           min="1">
                                                </td>
                                                <td class="border border-gray-300 p-2">{{ item.stock }}</td>
                                                <td class="border border-gray-300 p-2 text-center">
                                                    <button (click)="saveQuantity(i)"
                                                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded">
                                                        Cập nhật số lượng
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button type="button" (click)="confirmUpdate()"
                                    class="bg-blue-500 hover:bg-blue-700 text-white px-4 mr-2 py-2 rounded">Cập nhật trạng thái</button>
                                <button type="button" (click)="closePopup()"
                                    class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">Đóng</button>
                            </div>
                        </div>
                    </div>

                    <!-- Popup xác nhận -->
                    <div *ngIf="isConfirmUpdatePopupOpen"
                        class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                            <h2 class="text-lg font-bold mb-4">Xác nhận cập nhật đơn hàng</h2>
                            <p>Bạn có chắc chắn muốn cập nhật đơn hàng này?</p>
                            <div class="flex justify-end mt-4">
                                <button (click)="updateOrderStatus()"
                                    class="bg-green-500 hover:bg-green-700 text-white mr-4 px-4 py-2 rounded">Có</button>
                                <button (click)="closeConfirmPopup()"
                                    class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">Không</button>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="isConfirmDeletePopupOpen"
                        class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                            <h2 class="text-lg font-bold mb-4">Xác nhận xoá đơn hàng</h2>
                            <p>Bạn có chắc chắn muốn xoá đơn hàng này?</p>
                            <div class="flex justify-end mt-4">
                                <button (click)="deleteOrder()"
                                    class="bg-green-500 hover:bg-green-700 text-white mr-4 px-4 py-2 rounded">Có</button>
                                <button (click)="closeConfirmPopup()"
                                    class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">Không</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
        appearance: textfield;
    }
</style>